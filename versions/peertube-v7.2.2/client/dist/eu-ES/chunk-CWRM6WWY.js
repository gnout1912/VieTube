import{a as ae}from"./chunk-ZO2H6O7A.js";import{a as re}from"./chunk-JVRBW57G.js";import{Bb as F,Cb as S,E as Q,Ha as A,Oc as oe,Pb as ne,Rb as ie,Sa as ee,Y as D,Ya as x,_ as R,aa as y,c as G,eb as I,ha as Z,ia as K,jb as L,n as J,nb as _,ob as v,pb as z,qa as Y,s as T,sa as W,ta as m,tb as te,xb as se}from"./chunk-F7FAPFPY.js";import{a as c,b as X,i as u,j as d}from"./chunk-AI7IVZV2.js";function ye(){return new XMLHttpRequest();}function ue(s){s=null;}var U=class{buildXhr;constructor(e){this.buildXhr=e;}request=({method:e="GET",data:n=null,headers:t={},url:i,responseType:o,signal:l,onUploadProgress:w,timeout:b=0,withCredentials:g=!1,validateStatus:me=O=>O<400&&O>=200})=>new Promise((O,V)=>{let r=this.buildXhr(),P=()=>r&&r.readyState!==r.DONE&&r.abort();l?.addEventListener("abort",P,{once:!0}),r.open(e,i,!0),r.timeout=b,g&&(r.withCredentials=!0),o&&o!=="json"&&(r.responseType=o),Object.keys(t).forEach(p=>r.setRequestHeader(p,String(t[p]))),r.upload.onprogress=w||null,r.onerror=r.ontimeout=r.onabort=p=>(ue(r),l?.removeEventListener("abort",P),V({error:p.type,url:i,method:e})),r.onload=()=>{let p={data:this.getResponseBody(r,o),status:r.status,headers:this.getResponseHeaders(r)};return ue(r),l?.removeEventListener("abort",P),me(p.status)?O(p):V(p);},r.send(n);});getResponseHeaders(e){return e.getAllResponseHeaders().split(/[\r\n]+/).reduce((t,i)=>{let[o,l]=i.split(": ");return o&&(t[o.toLowerCase()]=l),t;},{});}getResponseBody(e,n){let t=typeof e.response>"u"?e.responseText:e.response;if(n==="json"&&t&&typeof t=="string")try{t=JSON.parse(t);}catch{}return t;}},Se=new R("uploadx.ajax",{factory:()=>new U(ye),providedIn:"root"}),k=class{onCancel=()=>{};cancel(){this.onCancel(),this.onCancel=()=>{};}},le=1024,a=class a{static scale(e){let n=a.size/e;return n<a.minChunkTime&&(a.size=Math.min(a.maxSize,a.size*2)),n>a.maxChunkTime&&(a.size=Math.max(a.minSize,a.size/2)),a.size;}};u(a,"maxSize",Number.MAX_SAFE_INTEGER),u(a,"minSize",256*le),u(a,"size",4*(256*le)),u(a,"minChunkTime",8),u(a,"maxChunkTime",24);var f=a;function M(s,e){return(s.match(e)||[""])[0];}function de(s,e){return s.indexOf("https://")*s.indexOf("http://")===0?s:s.indexOf("//")===0?M(e,/^(https?:)/)+s:s.indexOf("/")===0?M(e,/^(?:https?:)?(?:\/\/)?([^\/?]+)/)+s:M(e,/^(?:https?:)?(?:\/\/)?([^\/?]+)?(.*\/)/)+s;}function E(s,e){return s instanceof Function?s(e):s;}var ce=(s,e)=>{let n={};return e.forEach(t=>n[t]=s[t]),n;};function N(s){return s===Number(s);}function he(s){let e=2166136261,n=s.length;for(let t=0;t<n;t++)e^=s.charCodeAt(t),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24);return e>>>0;}function B(){return![typeof window,typeof navigator].includes("undefined");}function _e(){return B()?navigator.onLine:!0;}function ve(){return B()&&/iPad|iPhone/.test(navigator.userAgent);}function Ce(){let s=/OS (\d+)_(\d+)_?(\d+)?/.exec(navigator.userAgent);if(s?.length)return s[1]+"."+s[2]+"."+s[3]||"0";}function be(s,e){return s.localeCompare(e,void 0,{numeric:!0});}function Oe(){return ve()&&be(Ce()||"0.0","15.3")<0;}var Re=Oe()?{chunkSize:0,retryConfig:{shouldRetry:()=>!1}}:{},Ae=(()=>{let e=class e{generateId(t){let i=JSON.stringify(X(c({},t.metadata),{type:t.constructor.name,endpoint:t.endpoint}));return he(t.name+t.size).toString(16)+he(i).toString(16);}};u(e,"\u0275fac",function(i){return new(i||e)();}),u(e,"\u0275prov",D({token:e,factory:e.Éµfac,providedIn:"root"}));let s=e;return s;})(),h=function(s){return s[s.NotFound=0]="NotFound",s[s.Auth=1]="Auth",s[s.Retryable=2]="Retryable",s[s.Fatal=3]="Fatal",s;}(h||{}),Ee={maxAttempts:8,shouldRestartCodes:[404,410],authErrorCodes:[401],shouldRetryCodes:[408,423,429,460],shouldRetry(s){return s<400||s>=500||this.shouldRetryCodes.includes(s);},minDelay:500,maxDelay:5e4,onBusyDelay:1e3,timeout:0,keepPartial(s){return s>=400;}},j=class{attempts=0;config;observedValue;cancel=()=>{};constructor(e={}){this.config=Object.assign({},Ee,e);}kind(e){return this.attempts++,this.attempts>this.config.maxAttempts?h.Fatal:this.config.authErrorCodes.includes(e)?h.Auth:this.config.shouldRestartCodes.includes(e)?h.NotFound:this.config.shouldRetry(e,this.attempts)?h.Retryable:h.Fatal;}wait(e){let n=e||Math.min(2**(this.attempts-1)*this.config.minDelay,this.config.maxDelay),t=Math.floor(Math.random()*this.config.minDelay*this.attempts),i;return new Promise(o=>{this.cancel=()=>{clearTimeout(i),o();},i=setTimeout(this.cancel,n+t);});}observe(e){this.observedValue!==e&&(this.attempts=0),this.observedValue=e;}},pe=1e3*60*60,H=class{prefix;ttl=24*pe;constructor(e="UPLOADX-v4.0-"){this.prefix=e;}set(e,n){this.ttl&&localStorage.setItem(this.prefix+e,JSON.stringify([n,Date.now()+this.ttl]));}get(e){let n=localStorage.getItem(this.prefix+e);if(n){let[t,i]=JSON.parse(n);return t&&i?t:null;}return null;}delete(e){localStorage.removeItem(this.prefix+e);}clear(e=0){this.ttl=e*pe;let n=Date.now();this.keys().forEach(t=>{let i=localStorage.getItem(t);if(i&&e){let[,o]=JSON.parse(i);n>Number(o)&&localStorage.removeItem(t);}else localStorage.removeItem(t);});}keys(){return Object.keys(localStorage).filter(e=>e.indexOf(this.prefix)===0);}},C=we()?new H():new Map();function we(){try{let s="LocalStorageTest",e="value";localStorage.setItem(s,e);let n=localStorage.getItem(s);return localStorage.removeItem(s),n===e;}catch{return!1;}}var Pe={pause:"paused",upload:"queue",cancel:"cancelled",update:"updated"},q=class{file;options;stateChange;ajax;name;size;uploadId;response=null;responseStatus=0;responseHeaders={};progress=0;remaining;speed=0;headers={};metadata;endpoint="/upload";chunkSize=0;token;offset;retry;canceler=new k();abortController=new AbortController();responseType;_authorize;_prerequest;_token;_eventsCount=0;constructor(e,n,t,i){this.file=e,this.options=n,this.stateChange=t,this.ajax=i,this.retry=new j(n.retryConfig),this.name=e.name,this.size=e.size,this.metadata={name:e.name,mimeType:e.type||"application/octet-stream",size:e.size,lastModified:e.lastModified},n.maxChunkSize&&(f.maxSize=n.maxChunkSize),this._prerequest=n.prerequest||(o=>o),this._authorize=n.authorize||(o=>o),this.configure(n);}_url="";get url(){return this._url||C.get(this.uploadId)||"";}set url(e){this._url!==e&&C.set(this.uploadId,e),this._url=e;}_status;get status(){return this._status;}set status(e){e!=="updated"&&e!=="cancelled"&&(this._status===e||this._status==="complete")||this._status!=="cancelled"&&(this._status==="uploading"&&e==="queue"||(this._status==="retry"&&this.retry.cancel(),this._status=e,e==="paused"&&this.abort(),(e==="cancelled"||e==="complete"||e==="error")&&this.cleanup(),e==="cancelled"?this.cancelAndSendState():e==="updated"?this.updateAndSendState():this.stateChange(this)));}configure({metadata:e,headers:n,token:t,endpoint:i,action:o}){i&&(this.endpoint=i),t&&(this.token=t),e&&Object.assign(this.metadata,E(e,this.file)),n&&Object.assign(this.headers,E(n,this.file)),o&&(this.status=Pe[o]);}upload(){return d(this,null,function*(){do{this.status="uploading";try{this._token||=yield this.updateToken(),this.url||=yield this.getFileUrl(),this.offset!==this.size&&(this.offset=N(this.offset)?yield this.sendFileContent():yield this.getOffset()),this.retry.observe(this.offset),this.offset===this.size?(this.remaining=0,this.progress=100,this.status="complete"):N(this.offset)||(this.stateChange(this),yield this.retry.wait(this.getRetryAfterFromBackend()||this.retry.config.onBusyDelay));}catch(e){if(e instanceof Error&&console.error(e),this.status!=="uploading")return;switch(this.retry.kind(this.responseStatus)){case h.Fatal:this.status="error";return;case h.NotFound:this.url="";break;case h.Auth:this._token="";break;default:E(this.retry.config.keepPartial,this.responseStatus)&&(this.offset=void 0),this.status="retry",yield this.retry.wait(this.getRetryAfterFromBackend());}}}while(["uploading","retry","updated"].includes(this._status));});}request(e){return d(this,null,function*(){this.responseStatus=0,this.response=null,this.responseHeaders={},this.abortController.signal.aborted&&(this.abortController=new AbortController());let n=e.signal||this.abortController.signal,t={body:e.body||null,canceler:this.canceler,signal:n,headers:c(c({},this.headers),e.headers),method:e.method||"GET",url:e.url||this.url};e.skipAuthorization||(t=yield this._authorize(t,this._token));let{body:i=null,headers:o,method:l,url:w=t.url}=(yield this._prerequest(t))||t,b={method:l,headers:c(c({},t.headers),o),url:w,data:i,responseType:this.options.responseType??this.responseType,withCredentials:!!this.options.withCredentials,canceler:this.canceler,signal:n,validateStatus:()=>!0,timeout:this.retry.config.timeout};N(this.offset)&&i&&typeof i=="object"&&(b.onUploadProgress=this.onProgress());let g=yield this.ajax.request(b);if(this.response=g.data,this.responseHeaders=g.headers,this.responseStatus=g.status,g.status>=400)return Promise.reject();});}updateToken=()=>E(this.token||"",this.responseStatus);update(e){return Promise.reject("Not implemented");}abort(){this.offset=void 0,this.abortController.abort(),this.canceler.cancel();}cancel(){return d(this,null,function*(){this.abort(),this.url&&(yield this.request({method:"DELETE"}).catch(()=>{}));});}getValueFromResponse(e){return this.responseHeaders[e.toLowerCase()]||null;}getChunk(e,n){this.responseStatus===413&&(f.maxSize=f.size=Math.floor(f.size/2)),this.chunkSize=this.options.chunkSize===0?this.size:this.options.chunkSize||f.size;let t=e??this.offset??0,i=Math.min(t+(n||this.chunkSize),this.size),o=this.file.slice(t,i);return{start:t,end:i,body:o};}getRetryAfterFromBackend(){return Number(this.getValueFromResponse("retry-after"))*1e3;}cancelAndSendState(){this.cancel().then(()=>this.stateChange(this),console.error);}updateAndSendState(){this.update({metadata:this.metadata}).then(()=>this.stateChange(this),console.error);}cleanup=()=>{C.delete(this._url),C.delete(this.uploadId);};onProgress(){let e,n=Date.now();return({loaded:t})=>{let i=t/((Date.now()-n)/1e3);if(this.speed=~~((this.speed*this._eventsCount+i)/++this._eventsCount),f.scale(this.speed),!e){e=setTimeout(()=>e=void 0,500);let o=(this.offset||0)+t;this.progress=+(o/this.size*100).toFixed(2),this.remaining=~~((this.size-o)/this.speed),this.stateChange(this);}};}},$=class extends q{responseType="json";getFileUrl(){return d(this,null,function*(){let e=JSON.stringify(this.metadata),n={"Content-Type":"application/json; charset=utf-8","X-Upload-Content-Length":this.size,"X-Upload-Content-Type":this.file.type||"application/octet-stream"};yield this.request({method:"POST",body:e,url:this.endpoint,headers:n}),this.offset=this.getOffsetFromResponse()||(this.responseStatus===201?0:void 0);let t=this.getValueFromResponse("location");if(!t)throw new Error("Invalid or missing Location header");return de(t,this.endpoint);});}sendFileContent(){return d(this,null,function*(){let{body:e,start:n,end:t}=this.getChunk(),i={"Content-Type":"application/octet-stream","Content-Range":`bytes ${n}-${t-1}/${this.size}`};return yield this.request({method:"PUT",body:e,headers:i}),this.responseStatus>201?this.getOffsetFromResponse():t;});}getOffset(){return d(this,null,function*(){let e={"Content-Type":"application/octet-stream","Content-Range":`bytes */${this.size}`};return yield this.request({method:"PUT",headers:e}),this.responseStatus>201?this.getOffsetFromResponse():this.size;});}update(e){return d(this,null,function*(){let n=JSON.stringify(e),t={"Content-Type":"application/json; charset=utf-8"};yield this.request({method:"PATCH",body:n,headers:t});let i=this.getValueFromResponse("location")||this.url;return de(i,this.endpoint);});}getOffsetFromResponse(){let e=this.getValueFromResponse("Range");return e?Te(e)+1:void 0;}};function Te(s=""){let e=parseInt(s.split(/-/)[1],10);return e>=0?e:-1;}var De={endpoint:"/upload",autoUpload:!0,concurrency:2,uploaderClass:$,authorize:(s,e)=>(e&&(s.headers.Authorization=`Bearer ${e}`),s),storeIncompleteHours:24},xe=new R("uploadx.factory.options",{providedIn:"root",factory:()=>De}),Ie=new R("uploadx.options");var fe=["file","name","progress","remaining","response","responseHeaders","responseStatus","size","speed","status","uploadId","url"],Le=5,at=(()=>{let e=class e{queue=[];options;eventsStream=new G();subs=[];ngZone=y(Y);ajax=y(Se);idService=y(Ae);constructor(){let t=y(Ie,{optional:!0}),i=y(xe);this.options=Object.assign({},i,t),B()&&this.subs.push(T(window,"online").subscribe(()=>this.control({action:"upload"})),T(window,"offline").subscribe(()=>this.control({action:"pause"})));}get events(){return this.eventsStream.asObservable();}init(t={}){return Object.assign(this.options,t),this.events;}connect(t){return this.init(t).pipe(J(()=>this.queue),Q(Le));}disconnect(){this.queue.forEach(t=>t.status="paused"),this.queue=[];}state(){return this.queue.map(t=>ce(t,fe));}ngOnDestroy(){this.disconnect(),this.subs.forEach(t=>t.unsubscribe());}handleFiles(t,i={}){let o=c(c(c({},this.options),Re),i);C.clear(o.storeIncompleteHours),this.options.concurrency=o.concurrency,("name"in t?[t]:Array.from(t)).forEach(l=>this.addUploaderInstance(l,o));}control(t){(t.uploadId?this.queue.filter(({uploadId:o})=>o===t.uploadId):this.queue).forEach(o=>o.configure(t));}get activeUploadsCount(){return this.queue.filter(({status:t})=>t==="uploading"||t==="retry").length;}request(t){return d(this,null,function*(){return t.data||=t.body,this.ajax.request(t);});}stateChange=t=>{this.ngZone.run(()=>this.eventsStream.next(ce(t,fe))),t.status!=="uploading"&&t.status!=="added"&&this.ngZone.runOutsideAngular(()=>setTimeout(()=>this.processQueue()));};addUploaderInstance(t,i){return d(this,null,function*(){let o=new i.uploaderClass(t,i,this.stateChange,this.ajax);o.uploadId=yield this.idService.generateId(o),this.queue.push(o),o.status="added",i.autoUpload&&_e()&&(o.status="queue");});}processQueue(){this.queue=this.queue.filter(({status:t})=>t!=="cancelled"),this.queue.filter(({status:t})=>t==="queue").slice(0,Math.max(this.options.concurrency-this.activeUploadsCount,0)).forEach(t=>t.upload());}};u(e,"\u0275fac",function(i){return new(i||e)();}),u(e,"\u0275prov",D({token:e,factory:e.Éµfac,providedIn:"root"}));let s=e;return s;})();function ze(s,e){if(s&1){let n=te();_(0,"div",1),z(1,"my-progress-bar",3),_(2,"input",4),F("click",function(){Z(n);let i=S(2);return K(i.retry.emit());}),v()();}if(s&2){let n=S(2);A(),I("label",n.error())("valueFormatted",n.error());}}function Fe(s,e){if(s&1&&(_(0,"my-alert",2)(1,"div"),se(2,0),v(),ne(3),v()),s&2){let n=S(2);A(3),ie(" ",n.error()," ");}}function Me(s,e){if(s&1&&x(0,ze,3,2,"div",1)(1,Fe,4,1,"my-alert",2),s&2){let n=S();L(n.enableRetryAfterError()?0:1);}}function Ne(s,e){if(s&1&&(_(0,"div"),z(1,"my-progress-bar",5),v()),s&2){let n=S();A(),I("value",n.uploadPercents())("valueFormatted",n.getUploadingLabel());}}var mt=(()=>{let e=class e{isUploading=m(void 0);uploadPercents=m(void 0);error=m(void 0);uploaded=m(void 0);enableRetryAfterError=m(void 0);uploadedLabel=m();retry=W();getUploadingLabel(){if(this.uploaded())return this.uploadedLabel()||"File uploaded!";let t=this.uploadPercents();return t===100?"Prozesatzen\u2026":""+t+"%";}};u(e,"\u0275fac",function(i){return new(i||e)();}),u(e,"\u0275cmp",ee({type:e,selectors:[["my-upload-progress"]],inputs:{isUploading:[1,"isUploading"],uploadPercents:[1,"uploadPercents"],error:[1,"error"],uploaded:[1,"uploaded"],enableRetryAfterError:[1,"enableRetryAfterError"],uploadedLabel:[1,"uploadedLabel"]},outputs:{retry:"retry"},decls:2,vars:1,consts:()=>{let t;t="Saiatu berriro";let i;i="Sorry, but something went wrong.";let o;return o="Igotakoa guztira",[i,[1,"d-flex"],["type","danger"],["value","100","theme","red",3,"label","valueFormatted"],["type","button","value",t,1,"peertube-button","secondary-button","ms-1",3,"click"],["label",o,"theme","green",3,"value","valueFormatted"]];},template:function(i,o){i&1&&x(0,Me,2,1)(1,Ne,2,2,"div"),i&2&&L(o.error()?0:o.isUploading()||o.uploaded()?1:-1);},dependencies:[oe,ae,re],styles:[`my-progress-bar[_ngcontent-%COMP%]{width:100%}
/*# sourceMappingURL=upload-progress.component-3HLAKP5S.css.map */`]}));let s=e;return s;})();export{de as a,$ as b,at as c,mt as d};/**i18n:1cf7c077143c4c267fdafbe5508f191afcef21bad6aba22a3a8dc180e1003753*///# sourceMappingURL=chunk-CWRM6WWY.js.map