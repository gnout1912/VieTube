var M=Object.defineProperty;var H=(o,e,t)=>e in o?M(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var V=(o,e,t)=>H(o,typeof e!="symbol"?e+"":e,t);import{l as u,g as x,i as W,a as j,b as N,j as G,O as A,p as w,P as Y,c as y,T as z,U as q}from"./jschannel-DkCUG_QY.js";const $="modulepreload",K=function(o){return"/client/standalone/videos/"+o},U={},D=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){let a=function(d){return Promise.all(d.map(c=>Promise.resolve(c).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),l=n?.nonce||n?.getAttribute("nonce");s=a(t.map(d=>{if(d=K(d),d in U)return;U[d]=!0;const c=d.endsWith(".css"),h=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${h}`))return;const m=document.createElement("link");if(m.rel=c?"stylesheet":$,c||(m.as="script"),m.crossOrigin="",m.href=d,l&&m.setAttribute("nonce",l),document.head.appendChild(m),c)return new Promise((P,E)=>{m.addEventListener("load",P),m.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${d}`)))})}))}function r(a){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=a,window.dispatchEvent(n),!n.defaultPrevented)throw a}return s.then(a=>{for(const n of a||[])n.status==="rejected"&&r(n.reason);return e().catch(r)})},I={CONTINUE_100:100,SWITCHING_PROTOCOLS_101:101,OK_200:200,CREATED_201:201,ACCEPTED_202:202,NO_CONTENT_204:204,RESET_CONTENT_205:205,PARTIAL_CONTENT_206:206,MULTIPLE_CHOICES_300:300,MOVED_PERMANENTLY_301:301,FOUND_302:302,SEE_OTHER_303:303,NOT_MODIFIED_304:304,TEMPORARY_REDIRECT_307:307,PERMANENT_REDIRECT_308:308,BAD_REQUEST_400:400,UNAUTHORIZED_401:401,PAYMENT_REQUIRED_402:402,FORBIDDEN_403:403,NOT_FOUND_404:404,METHOD_NOT_ALLOWED_405:405,NOT_ACCEPTABLE_406:406,REQUEST_TIMEOUT_408:408,CONFLICT_409:409,GONE_410:410,LENGTH_REQUIRED_411:411,PRECONDITION_FAILED_412:412,PAYLOAD_TOO_LARGE_413:413,URI_TOO_LONG_414:414,UNSUPPORTED_MEDIA_TYPE_415:415,RANGE_NOT_SATISFIABLE_416:416,EXPECTATION_FAILED_417:417,I_AM_A_TEAPOT_418:418,UNPROCESSABLE_ENTITY_422:422,LOCKED_423:423,TOO_MANY_REQUESTS_429:429,REQUEST_HEADER_FIELDS_TOO_LARGE_431:431,UNAVAILABLE_FOR_LEGAL_REASONS_451:451,INTERNAL_SERVER_ERROR_500:500,NOT_IMPLEMENTED_501:501,BAD_GATEWAY_502:502,SERVICE_UNAVAILABLE_503:503,GATEWAY_TIMEOUT_504:504,HTTP_VERSION_NOT_SUPPORTED_505:505,INSUFFICIENT_STORAGE_507:507},F={VIDEO_REQUIRES_PASSWORD:"video_requires_password",INCORRECT_VIDEO_PASSWORD:"incorrect_video_password"},Q={INVALID_GRANT:"invalid_grant"},_={PRIVATE:3,INTERNAL:4,PASSWORD_PROTECTED:5},b={PUBLISHED:1,TO_TRANSCODE:2,TO_IMPORT:3,WAITING_FOR_LIVE:4,LIVE_ENDED:5,TO_MOVE_TO_EXTERNAL_STORAGE:6,TRANSCODING_FAILED:7,TO_MOVE_TO_EXTERNAL_STORAGE_FAILED:8,TO_EDIT:9,TO_MOVE_TO_FILE_SYSTEM:10,TO_MOVE_TO_FILE_SYSTEM_FAILED:11},X={HLS:1},T=class T{static getServerTranslations(e,t){const i=T.getLocalePath(e,t);return i?fetch(i+"/server.json").then(s=>s.json()).catch(s=>{u.error("Cannot get server translations",s)}):Promise.resolve(void 0)}static loadLocaleInVideoJS(e,t,i){const s=T.getLocalePath(e,t);if(!s)return Promise.resolve(void 0);let r;T.videojsLocaleCache[s]?r=Promise.resolve(T.videojsLocaleCache[s]):r=fetch(s+"/player.json").then(n=>n.json()).then(n=>(T.videojsLocaleCache[s]=n,n)).catch(n=>{u.error("Cannot get player translations",n)});const a=N(t);return r.then(n=>i.addLanguage(x(a),n))}static getLocalePath(e,t){const i=N(t);if(!(!W(i)||j(i)))return e+"/client/locales/"+i}};V(T,"videojsLocaleCache",{});let S=T;function Z(o,e){return o==="true"?!0:o==="false"?!1:e}function g(o,e,t){return o.has(e)?o.get(e)==="1"||o.get(e)==="true":t}function v(o,e,t){return o.has(e)?o.get(e):t}function J(o){const e=[];for(const t of Object.keys(o))e.push(encodeURIComponent(t)+"="+encodeURIComponent(o[t]));return e.join("&")}function ee(o,e){const t=new URL(o),i=new URL(e);return t.hostname==="localhost"&&i.hostname==="localhost"?!0:t.origin===i.origin}function te(o,e,t){return o.isLocal&&e.tracker.enabled===!1||ne()?!1:t}function ie(o,e){return new Set([_.PRIVATE,_.INTERNAL]).has(o.privacy.id)||o.privacy.id===_.PASSWORD_PROTECTED&&!0}function se(o){return new Set([_.PRIVATE,_.INTERNAL,_.PASSWORD_PROTECTED]).has(o.privacy.id)}function re(o,e,t){return o.nsfw===!1||t?.account?.id===o.account.id?!1:e.instance.defaultNSFWPolicy==="warn"||e.instance.defaultNSFWPolicy==="blur"}function oe(o,e,t){return o.nsfw===!1||t?.account?.id===o.account.id?!1:e.instance.defaultNSFWPolicy==="blur"}function B(o,e,t){return o.nsfw===!1||t?.account?.id===o.account.id?!1:e.instance.defaultNSFWPolicy==="do_not_list"}function ne(){return!(window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection)}class ae{constructor(e){this.embed=e}channel;isReady=!1;resolutions=[];videoElPlayListener;videoElPauseListener;videoElEndedListener;videoElInterval;initialize(){this.constructChannel()}initWithVideo(){this.disposeStateTracking(),this.setupStateTracking(),this.isReady||this.notifyReady()}get player(){return this.embed.player}constructChannel(){const e=G.build({window:window.parent,origin:"*",scope:this.embed.getScope()});e.bind("setVideoPassword",(t,i)=>this.embed.setVideoPasswordByAPI(i)),e.bind("isPlaying",t=>!this.player.paused()),e.bind("play",(t,i)=>{const s=this.player.play();s&&s.catch(r=>{console.error("Cannot play the video",r)})}),e.bind("pause",(t,i)=>this.player.pause()),e.bind("seek",(t,i)=>this.player.currentTime(i)),e.bind("getCurrentTime",t=>this.player.currentTime()),e.bind("setVolume",(t,i)=>this.player.volume(i)),e.bind("getVolume",(t,i)=>this.player.volume()),e.bind("isReady",(t,i)=>this.isReady),e.bind("setResolution",(t,i)=>this.setResolution(i)),e.bind("getResolutions",(t,i)=>this.resolutions),e.bind("getCaptions",(t,i)=>this.getCaptions()),e.bind("setCaption",(t,i)=>this.setCaption(i)),e.bind("setPlaybackRate",(t,i)=>this.player.playbackRate(i)),e.bind("getPlaybackRate",(t,i)=>this.player.playbackRate()),e.bind("getPlaybackRates",(t,i)=>this.player.options_.playbackRates),e.bind("playNextVideo",(t,i)=>this.embed.playNextPlaylistVideo()),e.bind("playPreviousVideo",(t,i)=>this.embed.playPreviousPlaylistVideo()),e.bind("getCurrentPosition",(t,i)=>this.embed.getCurrentPlaylistPosition()),e.bind("getImageDataUrl",(t,i)=>this.embed.getImageDataUrl()),this.channel=e}setResolution(e){if(u.info(`Set resolution ${e}`),this.isWebVideo()&&e===-1){u.error("Auto resolution cannot be set in web video player mode");return}this.player.peertubeResolutions().select({id:e,fireCallback:!0})}getCaptions(){return this.player.textTracks().tracks_.map(e=>({id:e.id,src:e.src,label:e.label,mode:e.mode}))}setCaption(e){const t=this.player.textTracks().tracks_;for(const i of t)i.id===e?i.mode="showing":i.mode="disabled"}notifyReady(){this.isReady=!0,this.channel.notify({method:"ready",params:!0})}setupStateTracking(){let e="unstarted";this.videoElInterval=setInterval(()=>{const t=this.player?.currentTime()??0,i=this.player?.volume();this.channel.notify({method:"playbackStatusUpdate",params:{position:t,volume:i,duration:this.player?.duration(),playbackState:e}})},500),this.videoElPlayListener=()=>{e="playing",this.channel.notify({method:"playbackStatusChange",params:"playing"})},this.player.on("play",this.videoElPlayListener),this.videoElPauseListener=()=>{e="paused",this.channel.notify({method:"playbackStatusChange",params:"paused"})},this.player.on("pause",this.videoElPauseListener),this.videoElEndedListener=()=>{e="ended",this.channel.notify({method:"playbackStatusChange",params:"ended"})},this.player.on("ended",this.videoElEndedListener),this.player.peertubeResolutions().on("resolutions-added",()=>this.loadResolutions()),this.player.peertubeResolutions().on("resolutions-changed",()=>this.loadResolutions()),this.loadResolutions(),this.player.on("volumechange",()=>{this.channel.notify({method:"volumeChange",params:this.player.volume()})})}disposeStateTracking(){this.player&&(this.videoElPlayListener&&this.player.off("play",this.videoElPlayListener),this.videoElPauseListener&&this.player.off("pause",this.videoElPauseListener),this.videoElEndedListener&&this.player.off("ended",this.videoElEndedListener),clearInterval(this.videoElInterval))}loadResolutions(){this.resolutions=this.player.peertubeResolutions().getResolutions().map(e=>({id:e.id,label:e.label,active:e.selected,width:e.width,height:e.height})),this.channel.notify({method:"resolutionUpdate",params:this.resolutions})}isWebVideo(){return!!this.player.webVideo}}class le{constructor(e){this.serverUrl=e,this.userOAuthTokens=A.getUserTokens(w),this.userOAuthTokens&&this.setHeadersFromTokens()}LS_OAUTH_CLIENT_KEYS={CLIENT_ID:"client_id",CLIENT_SECRET:"client_secret"};userOAuthTokens;headers=new Headers;fetch(e,{optionalAuth:t,method:i},s){let r={};return ee(this.serverUrl,e)&&(s&&this.headers.set("x-peertube-video-password",s),(s||t)&&(r={headers:this.headers})),this.refreshFetch(e.toString(),{...r,method:i})}getHeaderTokenValue(){return this.userOAuthTokens?`${this.userOAuthTokens.tokenType} ${this.userOAuthTokens.accessToken}`:null}isLoggedIn(){return!!this.userOAuthTokens}refreshFetch(e,t){return fetch(e,t).then(i=>i.status!==I.UNAUTHORIZED_401?i:new Promise((r,a)=>{const n=w.getItem(this.LS_OAUTH_CLIENT_KEYS.CLIENT_ID),l=w.getItem(this.LS_OAUTH_CLIENT_KEYS.CLIENT_SECRET),d=new Headers;d.set("Content-Type","application/x-www-form-urlencoded");const c={refresh_token:this.userOAuthTokens.refreshToken,client_id:n,client_secret:l,response_type:"code",grant_type:"refresh_token"};fetch("/api/v1/users/token",{headers:d,method:"POST",body:J(c)}).then(h=>{if(h.status!==I.UNAUTHORIZED_401)return h.json()}).then(h=>{if(!h||h.code===Q.INVALID_GRANT)return A.flushLocalStorage(w),this.removeTokensFromHeaders(),r();this.userOAuthTokens.accessToken=h.access_token,this.userOAuthTokens.refreshToken=h.refresh_token,A.saveToLocalStorage(w,this.userOAuthTokens),this.setHeadersFromTokens(),r()}).catch(h=>{a(h)})}).catch(()=>{A.flushLocalStorage(w),this.removeTokensFromHeaders()}).then(()=>fetch(e,{...t,headers:this.headers})))}setHeadersFromTokens(){this.headers.set("Authorization",this.getHeaderTokenValue())}removeTokensFromHeaders(){this.headers.delete("Authorization")}}function p(){return window.location.origin}class de{constructor(e){this.http=e}pluginsManager;init(e){this.pluginsManager=new Y({peertubeHelpersFactory:t=>this.buildPeerTubeHelpers({pluginInfo:t,translations:e}),backendUrl:p()})}loadPlugins(e){this.pluginsManager.loadPluginsList(e)}ensurePluginsAreLoaded(){return this.pluginsManager.ensurePluginsAreLoaded("embed")}getPluginsManager(){return this.pluginsManager}buildPeerTubeHelpers(e){const{pluginInfo:t,translations:i}=e,s=()=>{throw new Error("This helper is not implemented in embed.")};return{getBaseStaticRoute:s,getBaseRouterRoute:s,getBaseWebSocketRoute:s,getBasePluginClientPath:s,getSettings:()=>{const r=this.getPluginUrl()+"/"+t.plugin.npmName+"/public-settings";return this.http.fetch(r,{optionalAuth:!0}).then(a=>a.json()).then(a=>a.publicSettings)},getUser:s,isLoggedIn:()=>this.http.isLoggedIn(),getAuthHeader:()=>{if(this.http.isLoggedIn())return{Authorization:this.http.getHeaderTokenValue()}},notifier:{info:s,error:s,success:s},showModal:s,getServerConfig:s,markdownRenderer:{textMarkdownToHTML:s,enhancedMarkdownToHTML:s},translate:r=>Promise.resolve(y(r,i))}}getPluginUrl(){return p()+"/api/v1/plugins"}}class he{constructor(e){this.pluginPlugin=e}themeManager=new z;loadThemeStyle(e){for(const i of e.theme.registered)this.themeManager.injectTheme(i,p());const t=this.getCurrentThemeName(e);u.info(`Enabling ${t} theme style.`),this.themeManager.loadThemeStyle(t),this.themeManager.injectCoreColorPalette()}loadThemePlugins(e){const t=this.getCurrentThemeName(e);u.info(`Loading ${t} theme plugins.`);const i=e.theme.registered.find(r=>r.name===t);if(e.theme.builtIn.map(r=>r.name).includes(t))u.info(`Enabling internal theme ${t}`);else if(i){u.info(`Adding scripts of theme ${t}`);const r=this.pluginPlugin.getPluginsManager();r.addPlugin(i,!0),r.reloadLoadedScopes()}}getCurrentThemeName(e){const t=e.theme.default;return t!=="default"?t:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"peertube-core-dark-brown":t}}class ue{constructor(e){this.playerHTML=e}liveSocket;stateChangeListeners=new Map;forceEndListeners=new Map;async listenForChanges(e){const{video:t,onPublishedVideo:i,onForceEnd:s}=e;if(!this.liveSocket){const n=(await D(async()=>{const{io:l}=await import("./index-DKkG2Ymg.js");return{io:l}},[])).io;this.liveSocket=n(p()+"/live-videos")}const r=n=>{if(n.state===b.PUBLISHED){this.playerHTML.removeInformation(),i();return}},a=()=>{s()};this.liveSocket.on("state-change",r),this.liveSocket.on("force-end",a),this.stateChangeListeners.set(t.uuid,r),this.forceEndListeners.set(t.uuid,a),this.liveSocket.emit("subscribe",{videoId:t.id})}stopListeningForChanges(e){{const t=this.stateChangeListeners.get(e.uuid);t&&this.liveSocket.off("state-change",t)}{const t=this.forceEndListeners.get(e.uuid);t&&this.liveSocket.off("force-end",t)}this.liveSocket.emit("unsubscribe",{videoId:e.id})}displayInfo(e){const{state:t,translations:i}=e;if(t===b.WAITING_FOR_LIVE){this.displayWaitingForLiveInfo(i);return}if(t===b.LIVE_ENDED){this.displayEndedLiveInfo(i);return}}displayWaitingForLiveInfo(e){this.playerHTML.displayInformation("This live is not currently streaming.",e)}displayEndedLiveInfo(e){this.playerHTML.displayInformation("This live has ended.",e)}}class ce{constructor(e){this.videoWrapperId=e,this.wrapperElement=document.getElementById(this.videoWrapperId)}wrapperElement;initVideoEl;informationElement;getInitVideoEl(){return this.initVideoEl}setInitVideoEl(e){this.initVideoEl=e}addInitVideoElToDOM(){this.wrapperElement.appendChild(this.initVideoEl)}displayError(e,t){u.error(e),this.initVideoEl&&(this.removeElement(this.initVideoEl),this.initVideoEl=void 0);const i=y(e,t),s=y("Sorry",t);document.title=s+" - "+i;const r=document.getElementById("error-block");r.style.display="flex";const a=document.getElementById("error-title");a.innerHTML=y("Sorry",t);const n=document.getElementById("error-content");n.innerHTML=i,this.wrapperElement.style.display="none"}async askVideoPassword(e){const{incorrectPassword:t,translations:i}=e;return new Promise(s=>{this.wrapperElement.style.display="none";const r=y("This video is password protected",i),a=y("You need a password to watch this video.",i);document.title=r;const n=document.getElementById("video-password-block");n.style.display="flex";const l=document.getElementById("video-password-title");l.innerText=r;const d=document.getElementById("video-password-content");if(d.innerText=a,t){const P=document.getElementById("video-password-error");P.innerText=y("Incorrect password, please enter a correct password",i),P.style.transform="scale(1.2)",setTimeout(()=>{P.style.transform="scale(1)"},500)}const c=document.getElementById("video-password-submit");c.innerText=y("Watch Video",i);const h=document.getElementById("video-password-input");h.placeholder=y("Password",i),document.getElementById("video-password-form").addEventListener("submit",P=>{P.preventDefault();const E=h.value;s(E)})})}removeVideoPasswordBlock(){const e=document.getElementById("video-password-block");e.style.display="none",this.wrapperElement.style.display="block"}displayInformation(e,t){this.informationElement&&this.removeInformation(),this.informationElement=document.createElement("div"),this.informationElement.className="player-information",this.informationElement.innerText=y(e,t),document.body.appendChild(this.informationElement)}removeInformation(){this.informationElement&&(this.removeElement(this.informationElement),this.informationElement=void 0)}removeElement(e){e.parentElement.removeChild(e)}}class pe{constructor(e,t,i){this.playerHTML=e,this.videoFetcher=t,this.peertubePlugin=i}autoplay;controls;controlBar;muted;loop;subtitle;enableApi=!1;startTime=0;stopTime;playbackRate;title;warningTitle;peertubeLink;p2pEnabled;bigPlayBackgroundColor;foregroundColor;waitPasswordFromEmbedAPI=!1;mode;scope="peertube";hasAPIEnabled(){return this.enableApi}hasAutoplay(){return this.autoplay}hasControls(){return this.controls}hasTitle(){return this.title}hasWarningTitle(){return this.warningTitle}hasP2PEnabled(){return!!this.p2pEnabled}hasBigPlayBackgroundColor(){return!!this.bigPlayBackgroundColor}getBigPlayBackgroundColor(){return this.bigPlayBackgroundColor}hasForegroundColor(){return!!this.foregroundColor}getForegroundColor(){return this.foregroundColor}getMode(){return this.mode}getScope(){return this.scope}mustWaitPasswordFromEmbedAPI(){return this.waitPasswordFromEmbedAPI}loadCommonParams(){try{const e=new URL(window.location.toString()).searchParams;this.controls=g(e,"controls",!0),this.controlBar=g(e,"controlBar",!0),this.muted=g(e,"muted",void 0),this.loop=g(e,"loop",!1),this.title=g(e,"title",!0),this.enableApi=g(e,"api",this.enableApi),this.waitPasswordFromEmbedAPI=g(e,"waitPasswordFromEmbedAPI",this.waitPasswordFromEmbedAPI),this.warningTitle=g(e,"warningTitle",!0),this.peertubeLink=g(e,"peertubeLink",!0),this.scope=v(e,"scope",this.scope),this.subtitle=v(e,"subtitle"),this.startTime=v(e,"start"),this.stopTime=v(e,"stop"),this.playbackRate=v(e,"playbackRate"),this.bigPlayBackgroundColor=v(e,"bigPlayBackgroundColor"),this.foregroundColor=v(e,"foregroundColor")}catch(e){u.error("Cannot get params from URL.",e)}}loadVideoParams(e,t){try{const i=new URL(window.location.toString()).searchParams;this.autoplay=g(i,"autoplay",!1),(t.state.id===b.LIVE_ENDED||t.state.id===b.WAITING_FOR_LIVE)&&(this.autoplay=!1),this.p2pEnabled=g(i,"p2p",this.isP2PEnabled(e,t));const s=v(i,"mode");s?s==="p2p-media-loader"?this.mode="p2p-media-loader":this.mode="web-video":Array.isArray(t.streamingPlaylists)&&t.streamingPlaylists.length!==0?this.mode="p2p-media-loader":this.mode="web-video"}catch(i){u.error("Cannot get params from URL.",i)}}getPlayerConstructorOptions(e){const{serverConfig:t,authorizationHeader:i}=e;return{controls:this.controls,controlBar:this.controlBar,muted:this.muted,loop:this.loop,playbackRate:this.playbackRate,inactivityTimeout:2500,videoViewIntervalMs:t.views.videos.watchingInterval.anonymous,metricsUrl:t.openTelemetry.metrics.enabled?p()+"/api/v1/metrics/playback":null,metricsInterval:t.openTelemetry.metrics.playbackStatsInterval,authorizationHeader:i,playerElement:()=>this.playerHTML.getInitVideoEl(),enableHotkeys:!0,peertubeLink:()=>this.peertubeLink,instanceName:t.instance.name,theaterButton:!1,serverUrl:p(),stunServers:t.webrtc.stunServers,language:navigator.language,pluginsManager:this.peertubePlugin.getPluginsManager(),errorNotifier:()=>{}}}async getPlayerLoadOptions(e){const{video:t,captionsResponse:i,videoFileToken:s,videoPassword:r,requiresPassword:a,translations:n,alreadyPlayed:l,forceAutoplay:d,playlist:c,live:h,storyboardsResponse:m,chaptersResponse:P,config:E}=e,[C,R,f]=await Promise.all([this.buildCaptions(i,n),this.buildStoryboard(m),this.buildChapters(P)]),L=re(t,E,null)||B(t,E,null),O=oe(t,E,null)||B(t,E,null);return{mode:this.mode,autoplay:!L&&(d||l||this.autoplay),forceAutoplay:d,p2pEnabled:this.p2pEnabled,subtitle:this.subtitle,storyboard:R,videoChapters:f,startTime:c?c.playlistTracker.getCurrentElement().startTimestamp:this.startTime,stopTime:c?c.playlistTracker.getCurrentElement().stopTimestamp:this.stopTime,videoCaptions:C,videoViewUrl:this.videoFetcher.getVideoViewsUrl(t.uuid),videoShortUUID:t.shortUUID,videoUUID:t.uuid,nsfwWarning:L?{flags:t.nsfwFlags,summary:t.nsfwSummary}:void 0,poster:O?null:p()+t.previewPath,duration:t.duration,videoRatio:t.aspectRatio,embedUrl:p()+t.embedPath,embedTitle:t.name,requiresUserAuth:ie(t),videoFileToken:s,requiresPassword:a,videoPassword:r,...this.buildLiveOptions(t,h),...this.buildPlaylistOptions(c),dock:this.buildDockOptions(t),webVideo:{videoFiles:t.files},hls:this.buildHLSOptions(t)}}buildLiveOptions(e,t){return e.isLive?{isLive:!0,liveOptions:{latencyMode:t.latencyMode}}:{isLive:!1}}async buildStoryboard(e){const{storyboards:t}=await e.json();if(!(!t||t.length===0))return{url:t[0].fileUrl,height:t[0].spriteHeight,width:t[0].spriteWidth,interval:t[0].spriteDuration}}async buildChapters(e){const{chapters:t}=await e.json();return t}buildPlaylistOptions(e){if(!e)return{nextVideo:{enabled:!1,displayControlBarButton:!1,getVideoTitle:()=>""},previousVideo:{enabled:!1,displayControlBarButton:!1}};const{playlistTracker:t,playNext:i,playPrevious:s,onVideoUpdate:r}=e;return{playlist:{elements:t.getPlaylistElements(),playlist:t.getPlaylist(),getCurrentPosition:()=>t.getCurrentPosition(),onItemClicked:a=>{t.setCurrentElement(a),r(a.video.uuid)}},previousVideo:{enabled:t.hasPreviousPlaylistElement(),handler:()=>s(),displayControlBarButton:!0},nextVideo:{enabled:t.hasNextPlaylistElement(),handler:()=>i(),getVideoTitle:()=>t.getNextPlaylistElement()?.video?.name,displayControlBarButton:!0},upnext:{isEnabled:()=>!0,isSuspended:()=>!1,timeout:0}}}buildHLSOptions(e){const t=e.streamingPlaylists.find(i=>i.type===X.HLS);if(t)return{playlistUrl:t.playlistUrl,segmentsSha256Url:t.segmentsSha256Url,redundancyBaseUrls:t.redundancies.map(i=>i.baseUrl),trackerAnnounce:e.trackerUrls,videoFiles:t.files}}async buildCaptions(e,t){if(e.ok){const{data:i}=await e.json();return i.map(s=>({label:y(s.language.label,t),language:s.language.id,automaticallyGenerated:s.automaticallyGenerated,src:s.fileUrl}))}return[]}buildDockOptions(e){if(!this.hasControls())return;const t=this.hasTitle()?e.name:void 0,i=this.hasWarningTitle()&&this.hasP2PEnabled()?y("Watching this video may reveal your IP address to others."):void 0;if(!t&&!i)return;const s=e.channel.avatars.filter(a=>a.width<50),r=s.length!==0?s[0]:void 0;return{title:t,description:i,avatarUrl:t&&r?r.path:void 0}}isP2PEnabled(e,t){const i=Z(w.getItem(q.P2P_ENABLED),e.defaults.p2p.embed.enabled);return te(t,e,i)}}class me{constructor(e){this.http=e}async loadPlaylist(e){const t=this.loadPlaylistInfo(e),i=this.loadPlaylistElements(e);let s,r;try{s=await t,r=s.status===I.OK_200}catch(a){u.error(a),r=!1}if(!r)throw s?.status===I.NOT_FOUND_404?new Error("This playlist does not exist."):new Error("We cannot fetch the playlist. Please try again later.");return{playlistResponse:s,videosResponse:await i}}async loadAllPlaylistVideos(e,t){let i=t.data,s=t.total,r=0;for(;s>i.length&&r<10;){const n=await(await this.loadPlaylistElements(e,i.length)).json();s=n.total,i=i.concat(n.data),r++}return r===10&&u.error("Cannot fetch all playlists elements, there are too many!"),i}loadPlaylistInfo(e){return this.http.fetch(this.getPlaylistUrl(e),{optionalAuth:!0})}loadPlaylistElements(e,t=0){const i=new URL(this.getPlaylistUrl(e)+"/videos");return i.search=new URLSearchParams({start:""+t,count:"100"}).toString(),this.http.fetch(i.toString(),{optionalAuth:!0})}getPlaylistUrl(e){return p()+"/api/v1/video-playlists/"+e}}class ye{constructor(e,t){this.playlist=e,this.playlistElements=t}currentPlaylistElement;getPlaylist(){return this.playlist}getPlaylistElements(){return this.playlistElements}hasNextPlaylistElement(e){return!!this.getNextPlaylistElement(e)}getNextPlaylistElement(e){if(e||(e=this.currentPlaylistElement.position+1),e>this.playlist.videosLength)return;const t=this.playlistElements.find(i=>i.position===e);return t?.video?t:this.getNextPlaylistElement(e+1)}hasPreviousPlaylistElement(e){return!!this.getPreviousPlaylistElement(e)}getPreviousPlaylistElement(e){if(e||(e=this.currentPlaylistElement.position-1),e<1)return;const t=this.playlistElements.find(i=>i.position===e);return t?.video?t:this.getNextPlaylistElement(e-1)}nextVideoTitle(){const e=this.getNextPlaylistElement();return e?e.video.name:""}setPosition(e){if(this.currentPlaylistElement=this.playlistElements.find(t=>t.position===e),this.currentPlaylistElement?.video||(u.error("Current playlist element is not valid.",this.currentPlaylistElement),this.currentPlaylistElement=this.getNextPlaylistElement()),!this.currentPlaylistElement)throw new Error("This playlist does not have any valid element")}setCurrentElement(e){this.currentPlaylistElement=e}getCurrentElement(){return this.currentPlaylistElement}getCurrentPosition(){return this.currentPlaylistElement?this.currentPlaylistElement.position:-1}}class Pe extends Error{serverCode;constructor(e,t){super(e),this.name="CustomError",this.serverCode=t}}class ge{constructor(e){this.http=e}async loadVideo({videoId:e,videoPassword:t}){const i=this.loadVideoInfo({videoId:e,videoPassword:t});let s,r;try{s=await i,r=s.status===I.OK_200}catch(d){u.error(d),r=!1}if(!r){if(s?.status===I.NOT_FOUND_404)throw new Error("This video does not exist.");if(s?.status===I.FORBIDDEN_403){const d=await s.json();throw new Pe(d.message||d.detail,d.code)}throw new Error("We cannot fetch the video. Please try again later.")}const a=this.loadVideoCaptions({videoId:e,videoPassword:t}),n=this.loadVideoChapters({videoId:e,videoPassword:t}),l=this.loadStoryboards(e);return{captionsPromise:a,chaptersPromise:n,storyboardsPromise:l,videoResponse:s}}loadLive(e){return this.http.fetch(this.getLiveUrl(e.uuid),{optionalAuth:!0}).then(t=>t.json())}loadVideoToken(e,t){return this.http.fetch(this.getVideoTokenUrl(e.uuid),{optionalAuth:!0,method:"POST"},t).then(i=>i.json()).then(i=>i.files.token)}getVideoViewsUrl(e){return this.getVideoUrl(e)+"/views"}loadVideoInfo({videoId:e,videoPassword:t}){return this.http.fetch(this.getVideoUrl(e),{optionalAuth:!0},t)}loadVideoCaptions({videoId:e,videoPassword:t}){return this.http.fetch(this.getVideoUrl(e)+"/captions",{optionalAuth:!0},t)}loadVideoChapters({videoId:e,videoPassword:t}){return this.http.fetch(this.getVideoUrl(e)+"/chapters",{optionalAuth:!0},t)}getVideoUrl(e){return p()+"/api/v1/videos/"+e}getLiveUrl(e){return p()+"/api/v1/videos/live/"+e}loadStoryboards(e){return this.http.fetch(this.getStoryboardsUrl(e),{optionalAuth:!0})}getStoryboardsUrl(e){return p()+"/api/v1/videos/"+e+"/storyboards"}getVideoTokenUrl(e){return this.getVideoUrl(e)+"/token"}}class k{player;api=null;config;translationsPromise;PeerTubePlayerManagerModulePromise;videojs;http;videoFetcher;playlistFetcher;peertubePlugin;peertubeTheme;playerHTML;playerOptionsBuilder;liveManager;peertubePlayer;playlistTracker;alreadyInitialized=!1;alreadyPlayed=!1;videoPassword;videoPasswordFromAPI;onVideoPasswordFromAPIResolver;requiresPassword;constructor(e){u.registerServerSending(p()),this.http=new le(p()),this.videoFetcher=new ge(this.http),this.playlistFetcher=new me(this.http),this.peertubePlugin=new de(this.http),this.peertubeTheme=new he(this.peertubePlugin),this.playerHTML=new ce(e),this.playerOptionsBuilder=new pe(this.playerHTML,this.videoFetcher,this.peertubePlugin),this.liveManager=new ue(this.playerHTML),this.requiresPassword=!1;try{this.config=JSON.parse(window.PeerTubeServerConfig)}catch(t){u.error("Cannot parse HTML config.",t)}}static async main(){const e="video-wrapper";await new k(e).init()}getScope(){return this.playerOptionsBuilder.getScope()}async init(){this.translationsPromise=S.getServerTranslations(p(),navigator.language),this.PeerTubePlayerManagerModulePromise=D(()=>import("./peertube-player-CRU-OIGb.js").then(t=>t.p),[]),this.config||(this.config=await this.http.fetch(p()+"/api/v1/config",{optionalAuth:!1}).then(t=>t.json())),this.peertubeTheme.loadThemeStyle(this.config);const e=this.isPlaylistEmbed()?await this.initPlaylist():this.getResourceId();if(e)return this.loadVideoAndBuildPlayer({uuid:e,forceAutoplay:!1})}async initPlaylist(){const e=this.getResourceId();try{const t=await this.playlistFetcher.loadPlaylist(e),[i,s]=await Promise.all([t.playlistResponse.json(),t.videosResponse.json()]),r=await this.playlistFetcher.loadAllPlaylistVideos(e,s);this.playlistTracker=new ye(i,r);const a=new URL(window.location.toString()).searchParams,n=v(a,"playlistPosition"),l=n?parseInt(n+"",10):1;this.playlistTracker.setPosition(l)}catch(t){this.playerHTML.displayError(t.message,await this.translationsPromise);return}return this.playlistTracker.getCurrentElement().video.uuid}initializeApi(){this.playerOptionsBuilder.hasAPIEnabled()&&(this.api||(this.api=new ae(this),this.api.initialize()))}setVideoPasswordByAPI(e){u.info("Setting password from API"),this.videoPasswordFromAPI=e,this.onVideoPasswordFromAPIResolver&&this.onVideoPasswordFromAPIResolver(e)}getPasswordByAPI(){return this.videoPasswordFromAPI?Promise.resolve(this.videoPasswordFromAPI):new Promise(e=>{this.onVideoPasswordFromAPIResolver=e})}async playNextPlaylistVideo(){const e=this.playlistTracker.getNextPlaylistElement();if(!e){u.info("Next element not found in playlist.");return}return this.playlistTracker.setCurrentElement(e),this.loadVideoAndBuildPlayer({uuid:e.video.uuid,forceAutoplay:!1})}async playPreviousPlaylistVideo(){const e=this.playlistTracker.getPreviousPlaylistElement();if(!e){u.info("Previous element not found in playlist.");return}this.playlistTracker.setCurrentElement(e),await this.loadVideoAndBuildPlayer({uuid:e.video.uuid,forceAutoplay:!1})}getCurrentPlaylistPosition(){return this.playlistTracker.getCurrentPosition()}async loadVideoAndBuildPlayer(e){const{uuid:t,forceAutoplay:i}=e;this.playerOptionsBuilder.loadCommonParams(),this.initializeApi();try{const{videoResponse:s,captionsPromise:r,chaptersPromise:a,storyboardsPromise:n}=await this.videoFetcher.loadVideo({videoId:t,videoPassword:this.videoPassword});return this.buildVideoPlayer({videoResponse:s,captionsPromise:r,chaptersPromise:a,storyboardsPromise:n,forceAutoplay:i})}catch(s){await this.handlePasswordError(s)?this.loadVideoAndBuildPlayer({...e}):this.playerHTML.displayError(s.message,await this.translationsPromise)}}async buildVideoPlayer(e){const{videoResponse:t,captionsPromise:i,chaptersPromise:s,storyboardsPromise:r,forceAutoplay:a}=e,n=t.json().then(async f=>{this.playerOptionsBuilder.loadVideoParams(this.config,f);const L=f.isLive?await this.videoFetcher.loadLive(f):void 0,O=se(f)?await this.videoFetcher.loadVideoToken(f,this.videoPassword):void 0;return{live:L,video:f,videoFileToken:O}}),[{video:l,live:d,videoFileToken:c},h,m,P,E]=await Promise.all([n,this.translationsPromise,i,s,r,this.buildPlayerIfNeeded()]),C=this.playlistTracker?{onVideoUpdate:f=>this.loadVideoAndBuildPlayer({uuid:f,forceAutoplay:!1}),playlistTracker:this.playlistTracker,playNext:()=>this.playNextPlaylistVideo(),playPrevious:()=>this.playPreviousPlaylistVideo()}:void 0,R=await this.playerOptionsBuilder.getPlayerLoadOptions({video:l,captionsResponse:m,chaptersResponse:P,config:this.config,translations:h,storyboardsResponse:E,videoFileToken:()=>c,videoPassword:()=>this.videoPassword,requiresPassword:this.requiresPassword,playlist:C,live:d,forceAutoplay:a,alreadyPlayed:this.alreadyPlayed});await this.peertubePlayer.load(R),this.alreadyInitialized||(this.player=this.peertubePlayer.getPlayer(),window.videojsPlayer=this.player,this.buildCSS(),this.api&&this.api.initWithVideo()),this.alreadyInitialized=!0,this.player.one("play",()=>{this.alreadyPlayed=!0}),this.videoPassword&&this.playerHTML.removeVideoPasswordBlock(),l.isLive&&(this.liveManager.listenForChanges({video:l,onPublishedVideo:()=>{this.liveManager.stopListeningForChanges(l),this.loadVideoAndBuildPlayer({uuid:l.uuid,forceAutoplay:!0})},onForceEnd:()=>this.endLive(l,h)}),l.state.id===b.WAITING_FOR_LIVE||l.state.id===b.LIVE_ENDED?(this.liveManager.displayInfo({state:l.state.id,translations:h}),this.peertubePlayer.disable()):this.player.one("ended",()=>this.endLive(l,h))),this.peertubePlugin.getPluginsManager().runHook("action:embed.player.loaded",void 0,{player:this.player,videojs:this.videojs,video:l})}buildCSS(){const e=document.getElementById("custom-css");this.playerOptionsBuilder.hasBigPlayBackgroundColor()&&e.style.setProperty("--embed-big-play-background-color",this.playerOptionsBuilder.getBigPlayBackgroundColor()),this.playerOptionsBuilder.hasForegroundColor()&&e.style.setProperty("--embed-foreground-color",this.playerOptionsBuilder.getForegroundColor())}getResourceId(){const e=window.location.search;if(e.startsWith("?videoId="))return e.replace(/^\?videoId=/,"");if(e.startsWith("?videoPlaylistId="))return e.replace(/^\?videoPlaylistId=/,"");const t=window.location.pathname.split("/");return t[t.length-1]}isPlaylistEmbed(){return window.location.pathname.split("/")[1]==="video-playlists"}endLive(e,t){this.liveManager.displayInfo({state:b.LIVE_ENDED,translations:t}),this.peertubePlayer.unload(),this.peertubePlayer.disable(),this.peertubePlayer.setPoster(e.previewPath)}async handlePasswordError(e){let t=null;if(e.serverCode===F.VIDEO_REQUIRES_PASSWORD?t=!1:e.serverCode===F.INCORRECT_VIDEO_PASSWORD&&(t=!0),t===null)return!1;if(this.requiresPassword=!0,this.playerOptionsBuilder.mustWaitPasswordFromEmbedAPI()){u.info("Waiting for password from Embed API");const i=await this.getPasswordByAPI();return i&&this.videoPassword!==i?(u.info("Using video password from API"),this.videoPassword=i,!0):(u.error("Password from embed API is not valid"),!1)}return this.videoPassword=await this.playerHTML.askVideoPassword({incorrectPassword:t,translations:await this.translationsPromise}),!0}async buildPlayerIfNeeded(){if(this.peertubePlayer){this.peertubePlayer.enable();return}const e=document.createElement("video");e.className="video-js vjs-peertube-skin",e.setAttribute("playsinline","true"),this.playerHTML.setInitVideoEl(e),this.playerHTML.addInitVideoElToDOM();const[{PeerTubePlayer:t,videojs:i}]=await Promise.all([this.PeerTubePlayerManagerModulePromise,this.translationsPromise.then(r=>(this.peertubePlugin.init(r),this.peertubePlugin.loadPlugins(this.config),this.peertubeTheme.loadThemePlugins(this.config),this.peertubePlugin.ensurePluginsAreLoaded()))]);this.videojs=i;const s=this.playerOptionsBuilder.getPlayerConstructorOptions({serverConfig:this.config,authorizationHeader:()=>this.http.getHeaderTokenValue()});this.peertubePlayer=new t(s),this.player=this.peertubePlayer.getPlayer()}getImageDataUrl(){const e=document.createElement("canvas");e.width=this.player.videoWidth(),e.height=this.player.videoHeight();const t=this.player.tech(!0).el();return e.getContext("2d").drawImage(t,0,0,e.width,e.height),e.toDataURL("image/jpeg")}}k.main().catch(o=>{window.displayIncompatibleBrowser(),u.error("Cannot init embed.",o)});export{D as _};
